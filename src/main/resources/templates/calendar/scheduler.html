<!DOCTYPE html>
<html xmlns:th="http://www.w3.org/1999/xhtml">
<head>
    <meta charset='utf-8'/>
    <link href='css/fullcalendar.min.css' rel='stylesheet'/>
    <link href='css/fullcalendar.print.min.css' rel='stylesheet' media='print'/>
    <link href='css/scheduler.min.css' rel='stylesheet'/>
    <script src="js/moment.min.js"></script>
    <script src="js/jquery.min.js"></script>
    <script src="js/jquery-ui.min.js"></script>
    <script src='js/fullcalendar.min.js'></script>
    <script src='js/scheduler.min.js'></script>
    <script>
        $(function () { // document ready

            $('#external-events .fc-event').each(function () {

                // store data so the calendar knows to render an event upon drop
                $(this).data('event', {
                    //title: $.trim($(this).text()), // use the element's text as the event title
                    title: $(this).html(),
                    stick: true// maintain when user navigates (see docs on the renderEvent method)
                });

                // make the event draggable using jQuery UI
                $(this).draggable({
                    zIndex: 999,
                    revert: true,      // will cause the event to go back to its
                    revertDuration: 0  //  original position after the drag
                });


            });

            $('#calendar').fullCalendar({
                defaultView: 'agendaDay',
                defaultDate: '2018-12-06',
                dragRevertDuration: 0,
                droppable: true,
                editable: true,
                selectable: true,
                eventLimit: true, // allow "more" link when too many events
                header: {
                    left: 'prev,next today',
                    center: 'title'
                    //right: 'agendaDay,agendaTwoDay,agendaWeek,month'
                },
                views: {
                    agendaTwoDay: {
                        type: 'agenda',
                        duration: {days: 2},

                        // views that are more than a day will NOT do this behavior by default
                        // so, we need to explicitly enable it
                        groupByResource: true

                        //// uncomment this line to group by day FIRST with resources underneath
                        //groupByDateAndResource: true
                    }
                },

                //// uncomment this line to hide the all-day slot
                allDaySlot: false,

                resources: [
                    {id: 'a', title: 'Group 1'},
                    {id: 'b', title: 'Group 2', eventColor: 'green'},
                    {id: 'c', title: 'Group 3', eventColor: 'orange'},
                    {id: 'd', title: 'Group 4', eventColor: 'red'}
                ],
                /*events: [
                    {id: '1', resourceId: 'a', start: '2018-04-06', end: '2018-04-08', title: 'event 1'},
                    {
                        id: '2',
                        resourceId: 'a',
                        start: '2018-04-07T09:00:00',
                        end: '2018-04-07T14:00:00',
                        title: 'Line 1 <br/>This is Line 2...'
                    },
                ]*/
                drop: function (date, jsEvent, ui, resourceId) {
                    console.log('drop', date.format(), resourceId);

                    // is the "remove after drop" checkbox checked?
                    if ($('#drop-remove').is(':checked')) {
                        // if so, remove the element from the "Draggable Events" list
                        $(this).remove();
                    }
                },
                eventReceive: function (event) { // called when a proper external event is dropped
                    $.ajax({
                        url: '/postLecture',
                        type: 'POST',
                        data: {
                            json: JSON.stringify({
                                name: "test"
                            })
                        },
                        dataType: 'json'
                    });
                    console.log('eventReceive', event);
                },

                eventDrop: function (event, element) { // called when an event (already on the calendar) is moved
                    console.log('eventDrop', event);
                },

                eventDragStop: function (event, jsEvent, ui, view) {

                    if (isEventOverDiv(jsEvent.clientX, jsEvent.clientY)) {
                        $('#calendar').fullCalendar('removeEvents', event._id);
                        var el = $("<div class='fc-event'>").appendTo('#external-events-listing').html(event.title);
                        el.draggable({
                            zIndex: 999,
                            revert: true,
                            revertDuration: 0
                        });
                        el.data('event', {title: event.title, id: event.id, stick: true});
                    }
                },

                select: function (start, end, jsEvent, view, resource) {
                    console.log(
                        'select',
                        start.format(),
                        end.format(),
                        resource ? resource.id : '(no resource)'
                    );
                },
                dayClick: function (date, jsEvent, view, resource) {
                    console.log(
                        'dayClick',
                        date.format(),
                        resource ? resource.id : '(no resource)'
                    );
                },

                eventRender: function (event, element) {
                    element.find('div.fc-title').html(element.find('div.fc-title').text());

                }
            });

        });

        var isEventOverDiv = function (x, y) {

            var external_events = $('#external-events');
            var offset = external_events.offset();
            offset.right = external_events.width() + offset.left;
            offset.bottom = external_events.height() + offset.top;

            // Compare
            if (x >= offset.left
                && y >= offset.top
                && x <= offset.right
                && y <= offset.bottom) {
                return true;
            }
            return false;

        }

    </script>
    <style>

        body {
            margin: 0;
            padding: 0;
            font-family: "Lucida Grande", Helvetica, Arial, Verdana, sans-serif;
            font-size: 14px;
        }

        #calendar {
            float: right;
            width: 900px;
            margin-top: 15px;
        }

        #wrap {
            width: 1100px;
            margin: 0 auto;
        }

        #external-events {
            float: left;
            width: 150px;
            padding: 0 10px;
            border: 1px solid #ccc;
            background: #eee;
            text-align: left;
            margin-top: 15px;
        }

        #external-events h4 {
            font-size: 16px;
            margin-top: 0;
            padding-top: 1em;
        }

        #external-events .fc-event {
            margin: 10px 0;
            cursor: pointer;
        }

        #external-events p {
            margin: 1.5em 0;
            font-size: 11px;
            color: #666;
        }

        #external-events p input {
            margin: 0;
            vertical-align: middle;
        }

    </style>
</head>
<body>
<div id='wrap'>

    <div th:each="year:${years}" id='external-events'>
        <div id='external-events-listing'>
            <h4 th:utext="'Year: ' + ${year.name} + '<br/>'
         + 'Term: ' + ${year.term} + '<br/>'
         + 'Students: ' + ${year.students}">Draggable Events</h4>
            <form th:each="lecture:${lectures}">
                <div th:utext="${lecture.workerInSubject.subject.name} + '<br/>'
            + 'Type: ' + ${lecture.workerInSubject.subject.type} + '<br/>'
            + ${lecture.workerInSubject.worker.title} + '<br/>'
            + ${lecture.workerInSubject.worker.name} + '<br/>'
            + ${lecture.workerInSubject.worker.surname}" class='fc-event'>My Event 1
                </div>
            </form>
        </div>
        <p>
            <input type='checkbox' id='drop-remove'/>
            <label for='drop-remove'>remove after drop</label>
        </p>
    </div>

    <div id='calendar'></div>

    <div style='clear:both'></div>

</div>
</body>
</html>
